<!DOCTYPE html>
<html lang="en"><head><meta charset="utf-8"><title>Chapter 4: Legacy code - Test-Driven Development MOOC</title><meta content="width=device-width, initial-scale=1.0" name="viewport"><link href="https://cdn.jsdelivr.net/npm/@openfonts/open-sans-condensed_all@1.44.2/index.min.css" rel="stylesheet"><link href="https://cdn.jsdelivr.net/npm/@fontsource/roboto-slab@5.0.17/index.min.css" rel="stylesheet"><link href="https://cdn.simplecss.org/simple.css" rel="stylesheet"><link href="/styles.css" rel="stylesheet"><script defer src="/custom-elements.mjs" type="module"></script></head><body><nav aria-label="Table of contents" id="site-navigation"><div class="nav-title">TDD MOOC</div><ul><li><a href="/">Course overview</a></li><li><a href="/practicalities/">Practicalities (Spring 2025)</a><ul><li><a href="/enrollment/">Enrollment for study credits</a></li></ul></li><li><span>Course material</span><ul><li><a href="/exercises/">Exercises</a></li><li><a href="/1-tdd/">Chapter 1: What is TDD</a></li><li><a href="/2-design/">Chapter 2: Refactoring and design</a></li><li><a href="/3-challenges/">Chapter 3: The Untestables</a></li><li><a aria-current="page" href="/4-legacy-code/">Chapter 4: Legacy code</a></li><li><a href="/5-advanced/">Chapter 5: Advanced techniques</a></li><li><a href="/6-afterword/">Chapter 6: To infinity and beyond</a></li></ul></li></ul><ul><li><a href="/credits/">About the material</a></li><li><a href="/coaching/">Technical coach for your team</a></li></ul></nav><main><h1>Chapter 4: Legacy code</h1><p>What is legacy code? Code written by someone else? Code that you're afraid to change? If the code would have tests, you could change it without fear of breaking existing behavior. Thus the most useful definition of legacy code is <em>code without tests</em>. <a href="https://www.amazon.com/Working-Effectively-Legacy-Michael-Feathers/dp/0131177052">[1]</a></p>
<p>The first step in refactoring is that the code has tests. <a href="https://martinfowler.com/books/refactoring.html">[2]</a> Otherwise it's just changing stuff and hoping for the best. Even if the code is bad, we can improve the design safely if it has tests. The biggest challenge with legacy code is that it was not written with testing in mind.</p>
<h2><a href="#seams" id="seams">Seams</a></h2>
<p>A seam is a place in the code where you can alter the behavior of the program without editing that place. In object-oriented languages, the most common seam is a polymorphic method call. In some languages (e.g. C), preprocessor and linker based seams are also an option.</p>
<p>The basic strategy for changing legacy code is:</p>
<ol>
<li>Identify the place you need to change.</li>
<li>Plan that where would be a good place to test it.</li>
<li>Break dependencies which hinder testing. Without tests, you must introduce new seams using minimal, safe changes. The code quality may temporarily worsen.
<ul>
<li>As an example, the <em>Extract and Override Call</em> technique goes like this: Extract the difficult line of code to a new method. In tests, create a testable subclass which overrides the problematic method with a fake implementation. Write tests against that testable subclass.</li>
</ul>
</li>
<li>Cover the code with characterization tests.</li>
<li>Do the change you originally wanted.</li>
<li>Refactor and make the code more testable.</li>
</ol>
<p>A whole book has been written about this topic, so it doesn't need to be repeated here. Read the book - <a href="https://www.commitstrip.com/en/2019/03/13/like-a-good-wine/">it gets better with age</a>.</p>
<aside class="recommended-reading"><h5 class="heading">ðŸ“– Recommended reading</h5><div class="content">
<ul>
<li><a href="https://www.amazon.com/Working-Effectively-Legacy-Michael-Feathers/dp/0131177052">Working Effectively with Legacy Code</a> - the definitive book about refactoring legacy code</li>
</ul>
</div></aside>
<h2><a href="#code-coverage" id="code-coverage">Code coverage</a></h2>
<p><a href="https://www.usenix.org/conference/osdi14/technical-sessions/presentation/yuan">A study from 2014</a> found that 58% of catastrophic failures were caused by "trivial mistakes or can be exposed by statement coverage testing." With TDD you'll get such coverage out of the box, but in non-TDD'ed codebases you can't trust that everything has been covered.</p>
<p>Code coverage tools can be useful in finding untested areas, but not all of them can tell whether the code is well tested.</p>
<p><strong>Line/statement coverage</strong> says whether a line was executed by a test. (You could have 100% line coverage even if the tests have zero assertions.)</p>
<p><strong>Branch/edge/condition coverage</strong> also makes a distinction between partially executed lines. For example in <code>a = b() &amp;&amp; c()</code>, if <code>b()</code> returns false then <code>c()</code> is never executed. Line coverage would say the line was 100% covered, but branch coverage would say it was 50% covered. (You could have 100% branch coverage even if the tests have zero assertions.)</p>
<p><strong>Mutation coverage</strong> introduces bugs into your code and alarms if no test noticed them. It'll actually test your tests. For a code like <code>a = b() &amp;&amp; c()</code>, it could try mutations <code>a = b() || c()</code>, <code>a = b() == c()</code>, <code>a = b() != c()</code>, <code>a = !b() &amp;&amp; c()</code>, <code>a = true &amp;&amp; c()</code>, <code>a = false &amp;&amp; c()</code> and so on. There can be some false warnings, so going through the coverage report takes more time, but refactoring the code to avoid the false warnings can sometimes improve code quality. Even when the mutation coverage tool is smart about which tests to run for each mutation, it's typically an order of magnitude slower than running the tests normally: if the tests normally run in 1 second, measuring mutation coverage might take 1 minute.</p>
<p>When writing tests for legacy code, code coverage can be helpful. See which lines are not covered and for each conditional, write test cases that cause the code to take both branches.</p>
<aside class="recommended-reading"><h5 class="heading">ðŸ“– Recommended reading</h5><div class="content">
<ul>
<li><a href="https://www.artima.com/weblogs/viewpost.jsp?thread=204677">How Much Unit Test Coverage Do You Need? - The Testivus Answer</a></li>
</ul>
</div></aside>
<h2><a href="#characterization-tests" id="characterization-tests">Characterization tests</a></h2>
<p><em>aka golden master, aka snapshot testing, aka approval testing.</em></p>
<p>With legacy code, the source code is the truth, even when it contains bugs. The first priority is improving the code coverage, so that the code can be refactored safely.</p>
<p>Write tests which just assert that the code <em>does what it does</em>. Understanding the code is not necessary for writing such tests; use code coverage to your advantage and make sure that every code path is executed.</p>
<p>After the code is covered with characterization tests, it can be refactored, making it easier to understand what the code does. After you understand the code, it's easier to write more descriptive tests for it and begin changing what the code does.</p>
<aside class="recommended-reading"><h5 class="heading">ðŸ“– Recommended reading</h5><div class="content">
<ul>
<li><a href="https://www.infoq.com/news/2007/03/characterization-testing/">Understanding Legacy Code with Characterization Testing</a> - what is characterization testing</li>
<li><a href="https://www.youtube.com/watch?v=8OxH9Lz0Ckg">Cutting Code Quickly: From 0% to Cleanly Refactored 100% Tested Code</a> - a technique for characterization testing and refactoring without having to understand the code</li>
</ul>
</div></aside>
<h2><a href="#fixing-bugs-test-first" id="fixing-bugs-test-first">Fixing bugs test-first</a></h2>
<p>An excellent time and place for improving legacy code's test coverage is when there is a bug to fix. First write a test which reproduces the bug, and then fix it. Having a test which reproduces the bug makes it easier to fix it, and once the test is in place, you can be sure that the same bug will not reappear.</p>
<p>In the larger scope, this slowly improves the codebase as a whole. Bugs tend to cluster together, so by writing tests for them and refactoring those areas of the code, it reduces the risk of other bugs in the same area.</p>
<p>Also when adding new features, it's best to do it test-first. You can write the new code as an isolated component using TDD, and then change the legacy code to just delegate to the new code. Little by little you grow oases of safe areas that are easy to work with, and those will be in the areas of the codebase which change most often.</p>
<hr />
<p>Proceed to <a href="/5-advanced">Chapter 5: Advanced techniques</a> or <a href="/exercises">Exercises</a></p>
</main><footer><div>This course was brought to you by <a href="https://twitter.com/EskoLuontola">Esko Luontola</a> and <a href="https://nitor.com/">Nitor</a>.</div><div><a href="https://github.com/luontola/tdd-mooc"><small>Website source code</small></a></div><div><a href="/credits"><small>Credits and about the material</small></a></div><div class="social-links-footer"><a aria-label="Mooc.fi Twitter profile" href="https://twitter.com/moocfi" title="Mooc.fi Twitter profile"><svg aria-hidden="true" role="img" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg"><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z" fill="currentColor"></path></svg></a><a aria-label="Mooc.fi Facebook profile" href="https://www.facebook.com/Moocfi" title="Mooc.fi Facebook profile"><svg aria-hidden="true" role="img" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg"><path d="M504 256C504 119 393 8 256 8S8 119 8 256c0 123.78 90.69 226.38 209.25 245V327.69h-63V256h63v-54.64c0-62.15 37-96.48 93.67-96.48 27.14 0 55.52 4.84 55.52 4.84v61h-31.28c-30.8 0-40.41 19.12-40.41 38.73V256h68.78l-11 71.69h-57.78V501C413.31 482.38 504 379.78 504 256z" fill="currentColor"></path></svg></a><a aria-label="Mooc.fi YouTube channel" href="https://www.youtube.com/@mooc-fi" title="Mooc.fi YouTube channel"><svg aria-hidden="true" role="img" viewBox="0 0 576 512" xmlns="http://www.w3.org/2000/svg"><path d="M549.655 124.083c-6.281-23.65-24.787-42.276-48.284-48.597C458.781 64 288 64 288 64S117.22 64 74.629 75.486c-23.497 6.322-42.003 24.947-48.284 48.597-11.412 42.867-11.412 132.305-11.412 132.305s0 89.438 11.412 132.305c6.281 23.65 24.787 41.5 48.284 47.821C117.22 448 288 448 288 448s170.78 0 213.371-11.486c23.497-6.321 42.003-24.171 48.284-47.821 11.412-42.867 11.412-132.305 11.412-132.305s0-89.438-11.412-132.305zm-317.51 213.508V175.185l142.739 81.205-142.739 81.201z" fill="currentColor"></path></svg></a></div><div class="university-links-footer"><div class="hy-logo"><a href="https://www.helsinki.fi"><svg aria-hidden="true" focusable="false" viewBox="0 0 1000 1000"><path d="M452 0h96v97h-96V0zm0 903h96v97h-96v-97zm380-358q-32-20-38-74-25 3-44-3-28-10-40-42-6-13-12-47t-13-52q-12-32-33-56-33-35-74-50-37-14-78-11 30 19 37 46 6 23-7 41t-36 19-42-12q-8-5-35-27-22-18-40-26-26-12-58-12-25 0-51 13 24 3 40 16 13 12 24 32 3 7 16 39 10 23 27 36t44 22q-13 6-38 6-29 0-55-15-20-11-45-36t-43-36q-28-16-61-16-16 0-29 4t-19 9q23 3 42 14 23 15 23 34 0 11-7 17t-19 5-23-12q-18-20-43-33t-54-12q-13 0-26 3T0 339q34 5 58 28t45 72q15 35 33 51 24 23 64 23 5 0 29-3 20-2 31 0 17 2 27 13 9 8 12 21 2 6 5 23 2 15 6 23 10 21 28 31 21 11 56 11-19 19-54 21-32 2-65-9t-49-28q2 46 25 80 25 37 68 50 49 14 113-4 18-5 30-1t19 24q16 41 71 35 48-5 79 6t59 42q8-81-77-135-15-9-23-19-6-8-9-19l-4-17q16 18 38 28 17 8 43 14 82 10 110 52 2-23-6-42-6-15-19-29-10-10-26-22-19-15-23-18-11-10-13-18 19 12 36 17t38 5q7-1 27-6t31-4q16 0 28 7 15 9 27 29 29-18 68-15 35 3 64 21-12-30-34-52-17-18-44-33-12-7-47-23-28-14-43-24zm-284 36h-96v-97h96v97z" fill="currentColor"></path></svg><span>University of Helsinki</span></a></div><div class="moocfi-logo"><a href="https://www.mooc.fi"><img alt="" src="/moocfi-logo.png"><span>MOOC.fi</span></a></div></div></footer></body></html>